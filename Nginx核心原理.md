[TOC]

# 第八章、Nginx基础架构

## 8.1、Web服务器设计中的关键约束

* 性能

  1. 网络性能

     这里的网络性能是针对Nginx服务而言的，网络性能指在不同负载下，Web服务在网络通信上的吞吐量。而带宽就是指在特定的网络连接上可以达到的最大吞吐量。所以网络性能受制于带宽。那么我们谈论的网络性能时候一般是考虑的高并发场景如何应对。

  2. 单次请求的延迟性RT（响应时间）

     RT就是指用户从请求到完整链路返回响应之间的持续时间。如果RT毛刺非常严重，那么就需要重点考虑该问题。因为好的服务不会出现突刺毛刺，而是比较均匀。

  3. 网络效率

     使用网络的效率，比如如下几种提高的方式：

     长连接keepalive代替端链接可以减少建立请求关闭连接带来的网络交互。使用压缩传送数据大小来增加相同的吞吐量下的信息携带量，

     使用缓存来减少网络交互次数等。

* 可伸缩性

  1. 可伸缩性指架构可以通过添加组件来提升服务，或者允许组件之间具有交互功能。一般可以通过简化组件，降低组件的耦合度，将服务分散到许多组件等方法来改善可伸缩性。组件对于一个请求是使用同步还是异步的方式来处理条件制约。

* 简单性

  1. 组件的简单程度。对于整体架构来说，通用性原则，统一组件的接口是分离关注点原则来设计组件的。

* 可扩展性

  对于web服务器来说动态的可修改性，部署好we b服务器后可以不停止，不重启服务的前提下，提供给用户不同的符合需求的功能。

  1. 可进化性

     可进化性表示我们在修改一个组件时候，对其他组件产生的负面影响程度。越是核心的组件设计的时候越慎重，抽象架构设计要求越高。

  2. 可扩展性

     将一个新的功能添加到系统中，不影响其他功能，这个是静态可扩展性。

     如果已经部署的服务在不停止，不重启等情况下添加新的功能，这个是动态可扩展性。

  3. 可定制性

     支持可定制性的风格一般会提高简单性和扩展性，因为通常情况下只会实现最常用的功能。

  4. 可配置性

     可配置性指web服务部署后，通过对服务提供的配置文件进行修改来提供不同的功能。与可扩展性，可重用性相关。

  5. 可重用性

     可重用性指的是一个应用中的功能组件在不被修改的情况下，可以在其他应用中重用的程度。

* 可见性

  关键组件的运行情况被监控的程度。比如网络链接数，缓存的使用情况等。

* 可移植性

  跨平台运行，这也是当下Nginx被大规模使用的必要条件

* 可靠性

  服务出现故障时候：避免单点故障，增加冗余，允许监控，用可恢复的动作来缩小故障的范围（比如限流，降级，容灾）。

## 8.2、Ngnix的架构设计

### 8.2.1、优秀的模块化设计

Ngnix高度模块化设计是Nginx的架构基础。

* 高度抽象的模块接口

  所有的模块都遵循同样的ngx_module_t接口设计规范，这减少了整个系统中的变数可以带来良好的简单性，静态可扩展性，可重用性。

* 模块接口非常简单，具有很高的灵活性

  ![image-20200617171721479](/Users/didi/Library/Application Support/typora-user-images/image-20200617171721479.png)

* 配置模块的设计

  Ngx_module_t接口有一个type成员，指明允许在设计模块时候定义模块类型这个概念。

* 核心模块接口的简单化

  Ngx_core_module（核心模块）,ngx_errlog_module（错误日志模块）,ngx_events_module（事件模块）,ngx_openssl_module（openssl模块）,ngx_http_module（http模块）,ngx_mail_module模块（mail模块）。

8.2.2、事件驱动架构

事件驱动架构---由一些事件发生源来产生事件，由一个或者多个事件收集器来收集，分发事件。然后许多事件处理器会注册自己感兴趣的事件，同时会消费这些事件。

![image-20200617180238622](/Users/didi/Library/Application Support/typora-user-images/image-20200617180238622.png)

传统的事件驱动架构如上图。

![image-20200617182134801](/Users/didi/Library/Application Support/typora-user-images/image-20200617182134801.png)

Nginx处理事件的简单模型

这里的问题和困难点事每个消费者不能由阻塞行为。

8.2.3、请求的多阶段异步处理

8.2.4、管理进程/多工作进程设计

8.2.5、平台无关的代码实现

8.2.6、内存池的设计

8.2.7、使用统一管道过滤器模式的HTTP过滤模块

8.2.8、其他一些用户模块

8.3、Nginx框架中的核心结构体ngx_cycle_t

8.3.1、ngx_listening_t结构体

8.3.2、ngx_cycle_t结构体

8.3.3、ngx_cycle_t支持的方法

8.4、Nginx启动时框架的处理流程

8.5、worker进程是如何工作的

8.6、master进程是如何工作的